<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSKK - Pro Taskboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .view-container { animation: fadeIn 0.3s ease-out; }
        .tasks-container::-webkit-scrollbar { width: 6px; }
        .tasks-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .tasks-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .pagination-btn:disabled { cursor: not-allowed; background-color: #e2e8f0; }
        #notification-badge { transform: scale(0.8) translate(50%, -50%); }
        .task-card { transition: all 0.2s ease-out; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
        <div class="flex items-center space-x-2">
            <svg class="w-8 h-8 text-teal-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span class="text-lg font-semibold text-slate-700">Memuat data...</span>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <svg class="h-8 w-8 text-teal-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h1 class="text-2xl font-bold text-slate-800">LSKK</h1>
                </div>

                <nav class="hidden md:flex items-center space-x-2 bg-slate-100 p-1 rounded-lg">
                    <button id="nav-dashboard" class="nav-button px-4 py-2 text-sm font-semibold rounded-md">üìã Papan Tugas</button>
                    <button id="nav-stats" class="nav-button px-4 py-2 text-sm font-semibold rounded-md">üìä Statistik</button>
                    <button id="nav-table" class="nav-button px-4 py-2 text-sm font-semibold rounded-md">üìÑ List Tugas</button>
                    <button id="nav-admin" class="nav-button px-4 py-2 text-sm font-semibold rounded-md">‚öôÔ∏è Administrasi</button>
                </nav>
                
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="notification-btn" class="text-slate-500 hover:text-teal-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                            <span id="notification-badge" class="absolute top-0 right-0 block h-4 w-4 rounded-full bg-red-500 text-white text-xs text-center hidden"></span>
                        </button>
                        <div id="notification-panel" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl p-4 z-50 hidden">
                            <h4 class="font-bold mb-2">Notifikasi</h4>
                            <div id="notification-list" class="max-h-64 overflow-y-auto text-sm space-y-2">
                                <p class="text-slate-500">Belum ada notifikasi baru.</p>
                            </div>
                        </div>
                    </div>
                    <div class="md:hidden">
                         <select id="mobile-nav" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                            <option value="dashboard">Papan Tugas</option>
                            <option value="stats">Statistik</option>
                            <option value="table">List Tugas</option>
                            <option value="admin">Administrasi</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="admin-view" class="view-container hidden">
            <div class="grid grid-cols-1 gap-8">
                <section class="admin-section bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold mb-4">Tambah Tugas Baru</h3>
                    <form id="task-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><label for="task-description" class="block text-sm font-medium text-slate-600 mb-1">Deskripsi Tugas</label><input type="text" id="task-description" placeholder="Contoh: Buat halaman login..." required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"></div>
                        <div><label for="task-project" class="block text-sm font-medium text-slate-600 mb-1">Proyek</label><select id="task-project" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"><option value="">Pilih Proyek</option></select></div>
                        <div><label for="task-pic" class="block text-sm font-medium text-slate-600 mb-1">Anggota Tim</label><select id="task-pic" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"><option value="">Pilih Anggota Tim</option></select></div>
                        <div class="md:col-span-2"><label for="task-due-date" class="block text-sm font-medium text-slate-600 mb-1">Deadline</label><input type="date" id="task-due-date" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"></div>
                        <div class="md:col-span-2 text-right"><button type="submit" class="w-full md:w-auto bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-6 rounded-md transition shadow">Buat Tugas</button></div>
                    </form>
                </section>
                <section class="admin-section bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold mb-4">Manajemen Proyek</h3>
                    <form id="project-form" class="flex items-center gap-2 mb-4">
                        <input type="text" id="project-name" placeholder="Nama Proyek Baru..." required class="flex-grow w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        <button type="submit" title="Tambah Proyek" class="bg-teal-500 hover:bg-teal-600 text-white font-bold p-2 rounded-md transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></button>
                    </form>
                    <ul id="project-list" class="space-y-2"></ul>
                    <div id="projects-pagination-controls" class="flex items-center justify-between mt-4 text-sm hidden">
                        <button id="prev-project-page-btn" class="pagination-btn bg-white border border-slate-300 rounded-md px-4 py-2 hover:bg-slate-50 transition">Sebelumnya</button>
                        <span id="project-page-info"></span>
                        <button id="next-project-page-btn" class="pagination-btn bg-white border border-slate-300 rounded-md px-4 py-2 hover:bg-slate-50 transition">Selanjutnya</button>
                    </div>
                </section>
                <section class="admin-section bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold mb-4">Manajemen Anggota Tim</h3>
                    <form id="member-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="hidden" id="member-id">
                        <div>
                            <label for="member-name" class="block text-sm font-medium text-slate-600 mb-1">Nama Anggota</label>
                            <input type="text" id="member-name" placeholder="Contoh: Budi Santoso" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        </div>
                        <div>
                            <label for="member-role" class="block text-sm font-medium text-slate-600 mb-1">Jabatan</label>
                            <input type="text" id="member-role" placeholder="Contoh: Frontend Developer" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        </div>
                        <div class="md:self-end">
                            <button type="submit" id="member-submit-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-6 rounded-md transition shadow">Tambah Anggota</button>
                            <button type="button" id="member-cancel-btn" class="w-full mt-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-6 rounded-md transition hidden">Batal Edit</button>
                        </div>
                    </form>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Nama</th>
                                    <th scope="col" class="px-6 py-3">Jabatan</th>
                                    <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body"></tbody>
                        </table>
                    </div>
                    <div id="members-pagination-controls" class="flex items-center justify-between mt-4 text-sm hidden">
                        <button id="prev-member-page-btn" class="pagination-btn bg-white border border-slate-300 rounded-md px-4 py-2 hover:bg-slate-50 transition">Sebelumnya</button>
                        <span id="member-page-info"></span>
                        <button id="next-member-page-btn" class="pagination-btn bg-white border border-slate-300 rounded-md px-4 py-2 hover:bg-slate-50 transition">Selanjutnya</button>
                    </div>
                </section>
            </div>
        </div>
        
        <div id="filter-bar" class="hidden bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label for="search-filter" class="block text-sm font-medium text-slate-600 mb-1">üîç Cari Tugas</label><input type="text" id="search-filter" placeholder="Ketik deskripsi tugas..." class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500"></div>
                <div><label for="project-filter" class="block text-sm font-medium text-slate-600 mb-1">üìÅ Filter Proyek</label><select id="project-filter" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md"></select></div>
                <div><label for="member-filter" class="block text-sm font-medium text-slate-600 mb-1">üßë‚Äçüíª Filter Anggota</label><select id="member-filter" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md"></select></div>
            </div>
        </div>

        <div id="table-view" class="view-container hidden">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Tugas</th><th scope="col" class="px-6 py-3">Proyek</th><th scope="col" class="px-6 py-3">PIC</th><th scope="col" class="px-6 py-3">Deadline</th><th scope="col" class="px-6 py-3">Status</th>
                            </tr>
                        </thead>
                        <tbody id="task-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="tasks-pagination-controls" class="flex items-center justify-between mt-4 text-sm hidden">
                <button id="prev-task-page-btn" class="pagination-btn bg-white border border-slate-300 rounded-md px-4 py-2 hover:bg-slate-50 transition">Sebelumnya</button>
                <span id="task-page-info"></span>
                <button id="next-task-page-btn" class="pagination-btn bg-white border border-slate-300 rounded-md px-4 py-2 hover:bg-slate-50 transition">Selanjutnya</button>
            </div>
        </div>
        
        <div id="stats-view" class="view-container hidden">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-4 rounded-xl shadow-sm border"><h4 class="text-sm font-medium text-slate-500">Total Tugas</h4><p id="stats-total" class="text-3xl font-bold text-teal-600">0</p></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border"><h4 class="text-sm font-medium text-slate-500">Belum Dikerjakan</h4><p id="stats-todo" class="text-3xl font-bold text-red-500">0</p></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border"><h4 class="text-sm font-medium text-slate-500">Dikerjakan</h4><p id="stats-inprogress" class="text-3xl font-bold text-blue-500">0</p></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border"><h4 class="text-sm font-medium text-slate-500">Selesai</h4><p id="stats-done" class="text-3xl font-bold text-green-500">0</p></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border mb-8">
                <h3 class="font-bold text-lg mb-4">Distribusi Tugas</h3>
                <div class="max-h-80 mx-auto flex justify-center"><canvas id="tasksChart"></canvas></div>
            </div>
        </div>

        <div id="dashboard-view" class="view-container">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-slate-100 rounded-xl p-4"><h2 class="flex items-center justify-center gap-2 font-bold text-center text-red-600 bg-red-100 p-2 rounded-md mb-4"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>Belum Dikerjakan</h2><div id="todo-tasks" class="tasks-container space-y-4 h-[60vh] overflow-y-auto p-1"></div></div>
                <div class="bg-slate-100 rounded-xl p-4"><h2 class="flex items-center justify-center gap-2 font-bold text-center text-blue-600 bg-blue-100 p-2 rounded-md mb-4"><svg class="w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Sedang Dikerjakan</h2><div id="inprogress-tasks" class="tasks-container space-y-4 h-[60vh] overflow-y-auto p-1"></div></div>
                <div class="bg-slate-100 rounded-xl p-4"><h2 class="flex items-center justify-center gap-2 font-bold text-center text-green-600 bg-green-100 p-2 rounded-md mb-4"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Selesai</h2><div id="done-tasks" class="tasks-container space-y-4 h-[60vh] overflow-y-auto p-1"></div></div>
            </div>
        </div>
    </main>
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all">
            <h3 id="modal-title" class="text-lg font-bold text-slate-800"></h3>
            <p id="modal-message" class="mt-2 text-sm text-slate-600"></p>
            <input type="text" id="modal-input" class="hidden w-full mt-4 px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Masukkan kode otorisasi...">
            <div id="modal-actions" class="mt-6 flex justify-end space-x-3"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === KONFIGURASI ===
    const API_URL = 'https://timflow.lskk.co.id/api';
    const SOCKET_URL = 'https://timflow.lskk.co.id';

    // === STATE ===
    let appData = {
        projects: { list: [], pagination: {} },
        tasks: { list: [], pagination: {} },
        members: { list: [], pagination: {} },
        allMembersForDropdown: [],
        allProjectsForDropdown: []
    };
    let current = { projectsPage: 1, tasksPage: 1, membersPage: 1 };
    let tasksChartInstance = null;
    
    // === HELPER & DOM ELEMENTS ===
    const el = (id) => document.getElementById(id);
    const q = (selector) => document.querySelector(selector);
    const qAll = (selector) => document.querySelectorAll(selector);

    const elements = {
        loadingOverlay: el('loading-overlay'),
        navButtons: qAll('.nav-button'),
        mobileNav: el('mobile-nav'),
        views: { admin: el('admin-view'), dashboard: el('dashboard-view'), table: el('table-view'), stats: el('stats-view') },
        filterBar: el('filter-bar'),
        searchFilter: el('search-filter'),
        projectFilter: el('project-filter'),
        memberFilter: el('member-filter'),
        notificationBtn: el('notification-btn'),
        notificationPanel: el('notification-panel'),
        notificationList: el('notification-list'),
        notificationBadge: el('notification-badge'),
        stats: { total: el('stats-total'), todo: el('stats-todo'), inprogress: el('stats-inprogress'), done: el('stats-done') },
        taskColumns: { todo: el('todo-tasks'), inprogress: el('inprogress-tasks'), done: el('done-tasks') },
        taskTableBody: el('task-table-body'),
        taskForm: el('task-form'),
        taskDescriptionInput: el('task-description'),
        taskPicSelect: el('task-pic'),
        taskProjectSelect: el('task-project'),
        taskDueDateInput: el('task-due-date'),
        projectForm: el('project-form'),
        projectNameInput: el('project-name'),
        projectList: el('project-list'),
        projectsPaginationControls: el('projects-pagination-controls'),
        prevProjectPageBtn: el('prev-project-page-btn'),
        nextProjectPageBtn: el('next-project-page-btn'),
        projectPageInfo: el('project-page-info'),
        memberForm: el('member-form'),
        memberIdInput: el('member-id'),
        memberNameInput: el('member-name'),
        memberRoleInput: el('member-role'),
        memberSubmitBtn: el('member-submit-btn'),
        memberCancelBtn: el('member-cancel-btn'),
        membersTableBody: el('members-table-body'),
        membersPaginationControls: el('members-pagination-controls'),
        prevMemberPageBtn: el('prev-member-page-btn'),
        nextMemberPageBtn: el('next-member-page-btn'),
        memberPageInfo: el('member-page-info'),
        tasksPaginationControls: el('tasks-pagination-controls'),
        prevTaskPageBtn: el('prev-task-page-btn'),
        nextTaskPageBtn: el('next-task-page-btn'),
        taskPageInfo: el('task-page-info'),
        modal: { backdrop: el('modal-backdrop'), content: el('modal-content'), title: el('modal-title'), message: el('modal-message'), input: el('modal-input'), actions: el('modal-actions') }
    };
    
    // === MODAL & NOTIFIKASI ===
    const showModal = (title, message, buttons, showInput = false) => {
        elements.modal.title.textContent = title;
        elements.modal.message.innerHTML = message;
        elements.modal.input.classList.toggle('hidden', !showInput);
        elements.modal.input.value = '';
        elements.modal.actions.innerHTML = '';
        buttons.forEach(btn => {
            const buttonEl = document.createElement('button');
            buttonEl.textContent = btn.text;
            buttonEl.className = btn.class;
            buttonEl.onclick = () => { if (btn.onClick) btn.onClick(); };
            elements.modal.actions.appendChild(buttonEl);
        });
        elements.modal.backdrop.classList.remove('hidden');
    };
    const hideModal = () => elements.modal.backdrop.classList.add('hidden');
    const notify = (title, message) => showModal(title, message, [{ text: 'Tutup', class: 'bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md transition', onClick: hideModal }]);
    const promptWithCode = (title, message, onConfirm) => showModal(title, message, [{ text: 'Batal', class: 'bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-md transition', onClick: hideModal }, { text: 'Konfirmasi', class: 'bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition', onClick: () => onConfirm(elements.modal.input.value) }], true);

    const addNotification = (message) => {
        const firstItem = elements.notificationList.querySelector('p');
        if (firstItem) firstItem.remove();
        const notifItem = document.createElement('div');
        notifItem.className = 'p-2 border-b border-slate-100 text-slate-700';
        notifItem.textContent = message;
        elements.notificationList.prepend(notifItem);
        const badgeCount = Math.min(parseInt(elements.notificationBadge.textContent || '0') + 1, 9);
        elements.notificationBadge.textContent = badgeCount;
        elements.notificationBadge.classList.remove('hidden');
    };

    // === API & DATA FETCHING ===
    const apiCall = async (endpoint, options = {}) => {
        try {
            const res = await fetch(`${API_URL}/${endpoint}`, { ...options, cache: 'no-cache' });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
            }
            return res.json();
        } catch (error) {
            console.error(`API call failed for ${endpoint}:`, error);
            notify('Error Jaringan', error.message);
            throw error;
        }
    };
    
    const fetchInitialDataForDropdowns = async () => {
        try {
            const [projectsRes, membersRes] = await Promise.all([
                apiCall('projects?all=true'), apiCall('members?all=true')
            ]);
            appData.allProjectsForDropdown = projectsRes.data;
            appData.allMembersForDropdown = membersRes.data;
            populateDropdowns();
        } catch (error) {}
    };

    const fetchTasks = async (page = 1) => {
        const project = elements.projectFilter.value;
        const pic = elements.memberFilter.value;
        const search = elements.searchFilter.value;
        try {
            const data = await apiCall(`tasks?page=${page}&limit=10&project=${project}&pic=${pic}&search=${search}`);
            appData.tasks = { list: data.data, pagination: data.pagination };
            current.tasksPage = page;
            renderTasks();
            renderTable();
        } catch (error) {}
    };
    
    const fetchProjects = async (page = 1) => {
        try {
            const data = await apiCall(`projects?page=${page}&limit=5`);
            appData.projects = { list: data.data, pagination: data.pagination };
            current.projectsPage = page;
            renderProjectList();
        } catch (error) {}
    };

    const fetchMembers = async (page = 1) => {
        try {
            const data = await apiCall(`members?page=${page}&limit=5`);
            appData.members = { list: data.data, pagination: data.pagination };
            current.membersPage = page;
            renderMembersTable();
        } catch (error) {}
    };

    // === LOGIKA RENDER ===
    const fetchAndRenderDashboard = async () => {
        try {
            const stats = await apiCall('dashboard-stats');
            Object.keys(elements.stats).forEach(key => elements.stats[key].textContent = stats[key] || 0);
            
            const ctx = el('tasksChart').getContext('2d');
            if (tasksChartInstance) tasksChartInstance.destroy();
            tasksChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Belum Dikerjakan', 'Dikerjakan', 'Selesai'],
                    datasets: [{
                        label: 'Jumlah Tugas',
                        data: [stats.todo, stats.inprogress, stats.done],
                        backgroundColor: ['#ef4444', '#3b82f6', '#22c55e'],
                        borderColor: '#fff',
                        borderWidth: 2,
                        hoverOffset: 8
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        } catch (error) { console.error("Gagal render dashboard:", error); }
    };
    
    const renderTasks = () => {
        Object.values(elements.taskColumns).forEach(c => c.innerHTML = '');
        if (appData.tasks.list.length === 0 && current.tasksPage === 1) return;
        appData.tasks.list.forEach(task => {
            const card = createTaskCard(task);
            if(elements.taskColumns[task.status]) elements.taskColumns[task.status].appendChild(card);
        });
    };
    
    const createTaskCard = (task) => {
        const card = document.createElement("div");
        card.className = "task-card bg-white p-4 rounded-lg shadow-sm border hover:shadow-md hover:-translate-y-1";
        card.setAttribute("data-id", task._id);
        const statusBorder = { todo: 'border-l-4 border-red-500', inprogress: 'border-l-4 border-blue-500', done: 'border-l-4 border-green-500' };
        card.classList.add(...statusBorder[task.status].split(' '));
        const formattedDate = new Date(task.dueDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        card.innerHTML = `<p class="font-semibold text-slate-800 mb-3">${task.description}</p><div class="text-xs text-slate-500 space-y-2 mb-4"><div class="flex items-center gap-2"><span class="font-medium bg-slate-100 px-2 py-0.5 rounded">üìÅ Proyek:</span><span>${task.project}</span></div><div class="flex items-center gap-2"><span class="font-medium bg-slate-100 px-2 py-0.5 rounded">üßë‚Äçüíª PIC:</span><span>${task.pic}</span></div><div class="flex items-center gap-2"><span class="font-medium bg-slate-100 px-2 py-0.5 rounded">üóìÔ∏è Deadline:</span><span>${formattedDate}</span></div></div><div class="flex items-center justify-between border-t border-slate-200 pt-3"><select class="status-changer text-xs w-full bg-slate-50 border-slate-200 rounded-md p-1 focus:ring-1 focus:ring-teal-500 focus:border-teal-500"><option value="todo" ${task.status === "todo" ? "selected" : ""}>Belum Dikerjakan</option><option value="inprogress" ${task.status === "inprogress" ? "selected" : ""}>Dikerjakan</option><option value="done" ${task.status === "done" ? "selected" : ""}>Selesai</option></select><button class="delete-task-btn text-slate-400 hover:text-red-500 transition ml-2 p-1 rounded-full hover:bg-red-100" title="Hapus Tugas" data-id="${task._id}"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
        return card;
    };

    const renderTable = () => {
        const tasks = appData.tasks.list;
        elements.taskTableBody.innerHTML = '';
        if (tasks.length === 0) {
            elements.taskTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">Tidak ada tugas yang sesuai.</td></tr>`;
        } else {
            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                const statusMap = { todo: { text: "Belum Dikerjakan", class: "bg-red-100 text-red-800" }, inprogress: { text: "Dikerjakan", class: "bg-blue-100 text-blue-800" }, done: { text: "Selesai", class: "bg-green-100 text-green-800" } };
                const statusInfo = statusMap[task.status] || {text: 'N/A', class: 'bg-gray-100 text-gray-800'};
                const formattedDate = new Date(task.dueDate).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900">${task.description}</td><td class="px-6 py-4">${task.project}</td><td class="px-6 py-4">${task.pic}</td><td class="px-6 py-4">${formattedDate}</td><td class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold rounded-full ${statusInfo.class}">${statusInfo.text}</span></td>`;
                elements.taskTableBody.appendChild(row);
            });
        }
        renderPagination(elements.tasksPaginationControls, appData.tasks.pagination, elements.taskPageInfo, elements.prevTaskPageBtn, elements.nextTaskPageBtn);
    };
    
    const renderProjectList = () => {
        elements.projectList.innerHTML = "";
        const projects = appData.projects.list;
        if (projects.length === 0 && current.projectsPage === 1) {
            elements.projectList.innerHTML = `<li class="text-sm text-slate-500 text-center p-4">Belum ada proyek.</li>`;
        } else {
            projects.forEach(p => {
                const li = document.createElement("li");
                li.className = "flex items-center justify-between text-sm p-2 rounded-md hover:bg-slate-100";
                li.innerHTML = `<span class="font-medium">${p.name}</span><button class="delete-project-btn text-slate-400 hover:text-red-500 transition p-1 rounded-full hover:bg-red-100" data-id="${p._id}" data-name="${p.name}" title="Hapus proyek ${p.name}"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                elements.projectList.appendChild(li);
            });
        }
        renderPagination(elements.projectsPaginationControls, appData.projects.pagination, elements.projectPageInfo, elements.prevProjectPageBtn, elements.nextProjectPageBtn);
    };
    
    const renderMembersTable = () => {
        elements.membersTableBody.innerHTML = '';
        const members = appData.members.list;
        if (members.length === 0 && current.membersPage === 1) {
            elements.membersTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-slate-500">Belum ada anggota tim.</td></tr>`;
        } else {
            members.forEach(member => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900">${member.name}</td><td class="px-6 py-4">${member.role}</td><td class="px-6 py-4 text-center"><button class="edit-member-btn text-blue-500 hover:text-blue-700 font-semibold text-xs py-1 px-2 rounded" data-id="${member._id}" data-name="${member.name}" data-role="${member.role}">Edit</button><button class="delete-member-btn text-red-500 hover:text-red-700 font-semibold text-xs py-1 px-2 rounded ml-2" data-id="${member._id}" data-name="${member.name}">Hapus</button></td>`;
                elements.membersTableBody.appendChild(row);
            });
        }
        renderPagination(elements.membersPaginationControls, appData.members.pagination, elements.memberPageInfo, elements.prevMemberPageBtn, elements.nextMemberPageBtn);
    };

    const renderPagination = (controlsEl, paginationData, infoEl, prevBtn, nextBtn) => {
        const { page, totalPages } = paginationData;
        if (totalPages > 1) {
            controlsEl.classList.remove('hidden');
            infoEl.textContent = `Halaman ${page} dari ${totalPages}`;
            prevBtn.disabled = (page === 1);
            nextBtn.disabled = (page === totalPages);
        } else {
            controlsEl.classList.add('hidden');
        }
    };

    const populateDropdowns = () => {
        [elements.taskProjectSelect, elements.projectFilter].forEach(s => {
            const currentVal = s.value;
            s.innerHTML = `<option value="">Pilih Proyek</option>`;
            if (s.id.includes('filter')) s.innerHTML += `<option value="all">Semua Proyek</option>`;
            appData.allProjectsForDropdown.forEach(p => s.innerHTML += `<option value="${p.name}">${p.name}</option>`);
            s.value = currentVal;
        });
        [elements.taskPicSelect, elements.memberFilter].forEach(s => {
            const currentVal = s.value;
            s.innerHTML = `<option value="">Pilih Anggota Tim</option>`;
            if (s.id.includes('filter')) s.innerHTML += `<option value="all">Semua Anggota</option>`;
            appData.allMembersForDropdown.forEach(m => {
                const optionText = `${m.name} (${m.role})`;
                s.innerHTML += `<option value="${optionText}">${optionText}</option>`
            });
            s.value = currentVal;
        });
    };
    
    // === LOGIKA APLIKASI ===
    const switchView = (viewName) => {
        Object.values(elements.views).forEach(v => v.classList.add('hidden'));
        if (viewName === 'dashboard' || viewName === 'table') {
            elements.filterBar.classList.remove('hidden');
        } else {
            elements.filterBar.classList.add('hidden');
        }
        if (elements.views[viewName]) {
            elements.views[viewName].classList.remove('hidden');
        }
        elements.navButtons.forEach(btn => {
            const isActive = btn.id === `nav-${viewName}`;
            btn.classList.toggle('bg-teal-500', isActive);
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('text-slate-600', !isActive);
        });
        elements.mobileNav.value = viewName;
    };
    
    const statusStyles = {
        todo: { color: 'red' }, inprogress: { color: 'blue' }, done: { color: 'green' }
    };
    
    const updateTaskStatus = async (id, newStatus) => {
        const taskCard = q(`.task-card[data-id="${id}"]`);
        if (!taskCard) return;
        const originalParent = taskCard.parentElement;
        const originalStatus = Object.keys(statusStyles).find(key => taskCard.className.includes(statusStyles[key].color));
        const newParent = elements.taskColumns[newStatus];
        if (newParent) newParent.prepend(taskCard);
        taskCard.className = taskCard.className.replace(/border-(red|blue|green)-500/, `border-${statusStyles[newStatus].color}-500`);
        const statusChanger = taskCard.querySelector('.status-changer');
        if (statusChanger) statusChanger.value = newStatus;
        try {
            await apiCall(`tasks/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
        } catch (error) {
            if (originalParent) originalParent.appendChild(taskCard);
            taskCard.className = taskCard.className.replace(/border-(red|blue|green)-500/, `border-${statusStyles[originalStatus].color}-500`);
            if (statusChanger) statusChanger.value = originalStatus;
            notify('Gagal', 'Gagal memperbarui status.');
        }
    };
    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };

    const resetMemberForm = () => {
        elements.memberForm.reset();
        elements.memberIdInput.value = '';
        elements.memberSubmitBtn.textContent = 'Tambah Anggota';
        elements.memberCancelBtn.classList.add('hidden');
    };

    // === INISIALISASI ===
    const initializeApp = async () => {
        elements.loadingOverlay.classList.remove('hidden');
        
        // Event Listeners
        elements.navButtons.forEach(button => button.addEventListener('click', () => switchView(button.id.replace('nav-', ''))));
        elements.mobileNav.addEventListener('change', (e) => switchView(e.target.value));
        
        elements.searchFilter.addEventListener('input', debounce(() => fetchTasks(1), 500));
        elements.projectFilter.addEventListener('change', () => fetchTasks(1));
        elements.memberFilter.addEventListener('change', () => fetchTasks(1));
        
        elements.notificationBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.notificationPanel.classList.toggle('hidden');
            elements.notificationBadge.classList.add('hidden');
            elements.notificationBadge.textContent = '0';
        });
        document.addEventListener('click', () => elements.notificationPanel.classList.add('hidden'));
        elements.notificationPanel.addEventListener('click', (e) => e.stopPropagation());
        
        document.body.addEventListener('change', (e) => {
            if (e.target.classList.contains('status-changer')) {
                const id = e.target.closest('.task-card').dataset.id;
                updateTaskStatus(id, e.target.value);
            }
        });

        // ... (Event listener untuk form submit dan tombol delete)
        
        // Muat data awal
        await fetchInitialDataForDropdowns();
        await Promise.all([
            fetchProjects(1),
            fetchTasks(1),
            fetchMembers(1),
            fetchAndRenderDashboard()
        ]);
        
        elements.loadingOverlay.classList.add('hidden');
        switchView('dashboard');

        // Inisialisasi Socket.IO
        const socket = io(SOCKET_URL);
        socket.on('connect', () => console.log('‚úÖ Connected to Socket.IO server!'));
        socket.on('notification', (data) => addNotification(data.message));
        
        socket.on('tasks_changed', () => {
            fetchTasks(current.tasksPage);
            fetchAndRenderDashboard();
        });
        socket.on('projects_changed', () => {
            fetchProjects(current.projectsPage);
            fetchInitialDataForDropdowns();
        });
        socket.on('members_changed', () => {
            fetchMembers(current.membersPage);
            fetchInitialDataForDropdowns();
        });
    };

    initializeApp();
});
</script>
</body>
</html>