<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSKK - Papan Tugas Tim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .view-container, .task-card { animation: fadeIn 0.3s ease-out; }
        .tasks-container::-webkit-scrollbar { width: 6px; }
        .tasks-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .tasks-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="flex items-center space-x-2">
            <svg class="w-8 h-8 text-teal-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span class="text-lg font-semibold text-slate-700">Memuat data...</span>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <svg class="h-8 w-8 text-teal-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h1 class="text-2xl font-bold text-slate-800">LSKK</h1>
                </div>
                <nav class="hidden md:flex items-center space-x-2 bg-slate-100 p-1 rounded-lg">
                    <button id="nav-dashboard" class="nav-button px-4 py-2 text-sm font-semibold rounded-md">ğŸ“‹ Papan Tugas</button>
                    <button id="nav-table" class="nav-button px-4 py-2 text-sm font-semibold rounded-md">ğŸ“„ List Tabel</button>
                    <button id="nav-admin" class="nav-button px-4 py-2 text-sm font-semibold rounded-md">âš™ï¸ Admin & Kontrol</button>
                </nav>
                <div class="md:hidden">
                    <select id="mobile-nav" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                        <option value="dashboard">Papan Tugas</option>
                        <option value="table">List Tabel</option>
                        <option value="admin">Admin & Kontrol</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="admin-view" class="view-container hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold mb-4">Manajemen Proyek</h3>
                    <form id="project-form" class="flex items-center gap-2 mb-4">
                        <input type="text" id="project-name" placeholder="Nama Proyek Baru..." required class="flex-grow w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        <button type="submit" title="Tambah Proyek" class="bg-teal-500 hover:bg-teal-600 text-white font-bold p-2 rounded-md transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></button>
                    </form>
                    <ul id="project-list" class="space-y-2"></ul>
                </section>
                <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold mb-4">Tambah Tugas Baru</h3>
                    <form id="task-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><label for="task-description" class="block text-sm font-medium text-slate-600 mb-1">Deskripsi Tugas</label><input type="text" id="task-description" placeholder="Contoh: Buat halaman login..." required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"></div>
                        <div><label for="task-project" class="block text-sm font-medium text-slate-600 mb-1">Proyek</label><select id="task-project" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"><option value="">Pilih Proyek</option></select></div>
                        <div><label for="task-pic" class="block text-sm font-medium text-slate-600 mb-1">Anggota Tim</label><select id="task-pic" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"><option value="">Pilih Anggota Tim</option></select></div>
                        <div class="md:col-span-2"><label for="task-due-date" class="block text-sm font-medium text-slate-600 mb-1">Deadline</label><input type="date" id="task-due-date" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"></div>
                        <div class="md:col-span-2 text-right"><button type="submit" class="w-full md:w-auto bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-6 rounded-md transition shadow">Buat Tugas</button></div>
                    </form>
                </section>
            </div>
        </div>
        <div id="filter-bar" class="hidden bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="project-filter" class="block text-sm font-medium text-slate-600 mb-1">ğŸ“ Filter Proyek</label><select id="project-filter" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"></select></div>
                <div><label for="member-filter" class="block text-sm font-medium text-slate-600 mb-1">ğŸ§‘â€ğŸ’» Filter Anggota</label><select id="member-filter" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"></select></div>
            </div>
        </div>
        <div id="table-view" class="view-container hidden">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-600"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th scope="col" class="px-6 py-3">Tugas</th><th scope="col" class="px-6 py-3">Proyek</th><th scope="col" class="px-6 py-3">PIC</th><th scope="col" class="px-6 py-3">Deadline</th><th scope="col" class="px-6 py-3">Status</th></tr></thead><tbody id="task-table-body"></tbody></table></div></div>
        </div>
        <div id="dashboard-view" class="view-container">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-slate-100 rounded-xl p-4"><h2 class="flex items-center justify-center gap-2 font-bold text-center text-red-600 bg-red-100 p-2 rounded-md mb-4"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>Belum Dikerjakan</h2><div id="todo-tasks" class="tasks-container space-y-4 h-[60vh] overflow-y-auto p-1"></div></div>
                <div class="bg-slate-100 rounded-xl p-4"><h2 class="flex items-center justify-center gap-2 font-bold text-center text-blue-600 bg-blue-100 p-2 rounded-md mb-4"><svg class="w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Sedang Dikerjakan</h2><div id="inprogress-tasks" class="tasks-container space-y-4 h-[60vh] overflow-y-auto p-1"></div></div>
                <div class="bg-slate-100 rounded-xl p-4"><h2 class="flex items-center justify-center gap-2 font-bold text-center text-green-600 bg-green-100 p-2 rounded-md mb-4"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Selesai</h2><div id="done-tasks" class="tasks-container space-y-4 h-[60vh] overflow-y-auto p-1"></div></div>
            </div>
        </div>
    </main>
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"><div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all"><h3 id="modal-title" class="text-lg font-bold text-slate-800"></h3><p id="modal-message" class="mt-2 text-sm text-slate-600"></p><input type="text" id="modal-input" class="hidden w-full mt-4 px-3 py-2 bg-slate-50 border border-slate-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Masukkan kode otorisasi..."><div id="modal-actions" class="mt-6 flex justify-end space-x-3"></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => { // Hapus async dari sini
    // --- CONFIGURATION ---
    const API_URL = 'http://localhost:5102/api';
    const teamMembers = [
        "Asep Trisna Setiawan (PM)", "M. Aji Perdana (Backend Developer)", "M. Rizki Fahreaza (Mobile Developer)",
        "Faiza Kailani Kuswanto (Website Developer)", "Ahmad Sholeh Kurniawan (Mobile Developer)", "Harist Fadilah (Website Developer)","M. Daffa Prasetyo (UI/UX Designer)", "M Riza Nurtam (Infra)"
    ];
    // --- APPLICATION STATE ---
    let appData = { projects: [], tasks: [] };

    // --- DOM ELEMENTS ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const navButtons = document.querySelectorAll('.nav-button');
    const mobileNav = document.getElementById('mobile-nav');
    const views = { admin: document.getElementById('admin-view'), dashboard: document.getElementById('dashboard-view'), table: document.getElementById('table-view') };
    const filterBar = document.getElementById('filter-bar');
    const projectForm = document.getElementById('project-form');
    const projectNameInput = document.getElementById('project-name');
    const projectList = document.getElementById('project-list');
    const taskForm = document.getElementById('task-form');
    const taskDescriptionInput = document.getElementById('task-description');
    const taskPicSelect = document.getElementById('task-pic');
    const taskProjectSelect = document.getElementById('task-project');
    const taskDueDateInput = document.getElementById('task-due-date');
    const projectFilter = document.getElementById('project-filter');
    const memberFilter = document.getElementById('member-filter');
    const todoTasksContainer = document.getElementById('todo-tasks');
    const inprogressTasksContainer = document.getElementById('inprogress-tasks');
    const doneTasksContainer = document.getElementById('done-tasks');
    const taskTableBody = document.getElementById('task-table-body');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalInput = document.getElementById('modal-input');
    const modalActions = document.getElementById('modal-actions');

    // --- MODAL FUNCTIONS ---
    const showModal = (title, message, buttons, showInput = false) => {
        modalTitle.textContent = title;
        modalMessage.innerHTML = message;
        modalInput.classList.toggle('hidden', !showInput);
        modalInput.value = '';
        modalActions.innerHTML = '';
        buttons.forEach(btn => {
            const buttonEl = document.createElement('button');
            buttonEl.textContent = btn.text;
            buttonEl.className = btn.class;
            buttonEl.onclick = () => { if (!btn.onClick) hideModal(); if (btn.onClick) btn.onClick(); };
            modalActions.appendChild(buttonEl);
        });
        modalBackdrop.classList.remove('hidden');
        modalContent.style.animation = 'fadeIn 0.2s ease-out';
    };
    const hideModal = () => modalBackdrop.classList.add('hidden');
    const notify = (title, message) => showModal(title, message, [{ text: 'Tutup', class: 'bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md transition', onClick: hideModal }]);
    const promptWithCode = (title, message, onConfirm) => showModal(title, message, [{ text: 'Batal', class: 'bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-md transition', onClick: hideModal }, { text: 'Hapus', class: 'bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition', onClick: () => onConfirm(modalInput.value) }], true);

    // --- NAVIGATION ---
    const switchView = (viewName) => {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        filterBar.classList.add('hidden');
        if (views[viewName]) {
            views[viewName].classList.remove('hidden');
            if (viewName === 'dashboard' || viewName === 'table') filterBar.classList.remove('hidden');
        }
        navButtons.forEach(btn => {
            btn.classList.toggle('bg-teal-500', btn.id === `nav-${viewName}`);
            btn.classList.toggle('text-white', btn.id === `nav-${viewName}`);
            btn.classList.toggle('text-slate-600', btn.id !== `nav-${viewName}`);
        });
        mobileNav.value = viewName;
    };

    // --- API COMMUNICATION ---
    const fetchData = async () => {
        loadingOverlay.classList.remove('hidden');
        try {
            const [projectsRes, tasksRes] = await Promise.all([
                fetch(`${API_URL}/projects`, { cache: 'no-cache' }),
                fetch(`${API_URL}/tasks`, { cache: 'no-cache' })
            ]);
            if (!projectsRes.ok || !tasksRes.ok) throw new Error('Gagal mengambil data dari server.');
            appData.projects = await projectsRes.json();
            appData.tasks = await tasksRes.json();
            renderAll();
        } catch (error) {
            console.error('Error fetching data:', error);
            notify('Error Jaringan', 'Gagal memuat data dari server. Pastikan server backend sudah berjalan dan URL API benar.');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    };

    // --- DATA MANAGEMENT (CRUD via API) ---
    const addProject = async (e) => {
        e.preventDefault();
        const newName = projectNameInput.value.trim();
        if (!newName) return;
        try {
            const res = await fetch(`${API_URL}/projects`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            });
            if (!res.ok) {
               const errorData = await res.json();
               throw new Error(errorData.message || 'Nama proyek mungkin sudah ada.');
            }
            projectNameInput.value = "";
            await fetchData(); 
            notify('Sukses', 'Proyek baru berhasil ditambahkan!');
        } catch (error) {
            notify('Gagal', error.message);
        }
    };

    const deleteProject = async (id) => {
        promptWithCode(`Hapus Proyek`, "Yakin ingin menghapus proyek ini dan semua tugasnya? Masukkan kode otorisasi.", async (code) => {
            if (!code) return notify("Info", "Kode otorisasi harus diisi.");
            hideModal();
            try {
                const res = await fetch(`${API_URL}/projects/${id}`, { 
                    method: 'DELETE',
                    headers: { 'X-Auth-Code': code }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Gagal menghapus proyek.');
                }
                await fetchData();
                notify('Sukses', 'Proyek dan semua tugas terkait berhasil dihapus.');
            } catch (error) {
                notify('Gagal', error.message);
            }
        });
    };

    const addTask = async (e) => {
        e.preventDefault();
        const taskData = {
            description: taskDescriptionInput.value.trim(),
            pic: taskPicSelect.value,
            project: taskProjectSelect.value,
            dueDate: taskDueDateInput.value,
        };
        if (!taskData.description || !taskData.pic || !taskData.project || !taskData.dueDate) {
            return notify('Gagal', 'Semua field harus diisi.');
        }
        try {
            const res = await fetch(`${API_URL}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            });
            if (!res.ok) throw new Error('Gagal membuat tugas.');
            taskForm.reset();
            await fetchData();
            notify('Sukses', 'Tugas baru berhasil ditambahkan!');
        } catch (error) {
            notify('Gagal', 'Gagal membuat tugas baru di server.');
        }
    };

    const deleteTask = async (id) => {
        promptWithCode("Hapus Tugas", "Yakin ingin menghapus tugas ini? Masukkan kode otorisasi.", async (code) => {
            if (!code) return notify("Info", "Kode otorisasi harus diisi.");
            hideModal();
            try {
                const res = await fetch(`${API_URL}/tasks/${id}`, { 
                    method: 'DELETE',
                    headers: { 'X-Auth-Code': code }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Gagal menghapus tugas.');
                }
                await fetchData();
                notify('Sukses', 'Tugas berhasil dihapus.');
            } catch (error) {
                notify('Gagal', error.message);
            }
        });
    };

    const updateTaskStatus = async (id, newStatus) => {
        const originalStatus = appData.tasks.find(t => t._id === id)?.status;
        
        const taskIndex = appData.tasks.findIndex(t => t._id === id);
        if(taskIndex > -1) {
            appData.tasks[taskIndex].status = newStatus;
            applyFilters();
        }

        try {
            const res = await fetch(`${API_URL}/tasks/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            if (!res.ok) throw new Error('Gagal memperbarui status di server.');
        } catch (error) {
            if(taskIndex > -1) {
                appData.tasks[taskIndex].status = originalStatus;
                applyFilters();
            }
            notify('Gagal', 'Gagal memperbarui status tugas. Memulihkan kondisi semula.');
        }
    };

    // --- RENDER FUNCTIONS ---
    const applyFilters = () => {
        const selectedProject = projectFilter.value;
        const selectedMember = memberFilter.value;
        renderTasks(selectedProject, selectedMember);
        renderTable(selectedProject, selectedMember);
    };

    const renderTasks = (project, member) => {
        let tasksToRender = appData.tasks;
        if (project && project !== 'all') {
            tasksToRender = tasksToRender.filter(t => t.project === project);
        }
        if (member && member !== 'all') {
            tasksToRender = tasksToRender.filter(t => t.pic === member);
        }

        [todoTasksContainer, inprogressTasksContainer, doneTasksContainer].forEach(c => c.innerHTML = '');
        
        if (tasksToRender.length === 0) return; // Keluar jika tidak ada tugas untuk ditampilkan

        tasksToRender.forEach(task => {
            const card = createTaskCard(task);
            if (task.status === 'todo') todoTasksContainer.appendChild(card);
            else if (task.status === 'inprogress') inprogressTasksContainer.appendChild(card);
            else if (task.status === 'done') doneTasksContainer.appendChild(card);
        });
    };

    const renderTable = (project, member) => {
        let tasksToRender = appData.tasks;
        if (project && project !== 'all') {
            tasksToRender = tasksToRender.filter(t => t.project === project);
        }
        if (member && member !== 'all') {
            tasksToRender = tasksToRender.filter(t => t.pic === member);
        }
        
        taskTableBody.innerHTML = '';
        if (tasksToRender.length === 0) {
            taskTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">Tidak ada tugas yang sesuai.</td></tr>`;
            return;
        }
        tasksToRender.forEach(task => {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-slate-50';
            const statusMap = { todo: { text: "Belum Dikerjakan", class: "bg-red-100 text-red-800" }, inprogress: { text: "Dikerjakan", class: "bg-blue-100 text-blue-800" }, done: { text: "Selesai", class: "bg-green-100 text-green-800" } };
            const statusInfo = statusMap[task.status] || {text: 'N/A', class: 'bg-gray-100 text-gray-800'};
            const formattedDate = new Date(task.dueDate).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900">${task.description}</td><td class="px-6 py-4">${task.project}</td><td class="px-6 py-4">${task.pic}</td><td class="px-6 py-4">${formattedDate}</td><td class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold rounded-full ${statusInfo.class}">${statusInfo.text}</span></td>`;
            taskTableBody.appendChild(row);
        });
    };
    
   const createTaskCard = (task) => {
    const card = document.createElement("div");
    card.className = "task-card bg-white p-4 rounded-lg shadow-sm border border-slate-200 cursor-pointer hover:shadow-md hover:-translate-y-1 transition-all duration-200";
    card.setAttribute("data-id", task._id);
    
    const statusStyles = { 
        todo: 'border-l-4 border-red-500', 
        inprogress: 'border-l-4 border-blue-500', 
        done: 'border-l-4 border-green-500' 
    };

    // --- PERBAIKAN DI SINI ---
    // Kode lama yang error:
    // card.classList.add(statusStyles[task.status]);

    // Kode baru yang sudah benar:
    // 1. Pecah string menjadi array berdasarkan spasi -> ['border-l-4', 'border-red-500']
    // 2. Gunakan spread operator (...) untuk menambahkan setiap class satu per satu.
    card.classList.add(...statusStyles[task.status].split(' '));
    // --- AKHIR PERBAIKAN ---

    const formattedDate = new Date(task.dueDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric'});
    
    card.innerHTML = `<p class="font-semibold text-slate-800 mb-3">${task.description}</p><div class="text-xs text-slate-500 space-y-2 mb-4"><div class="flex items-center gap-2"><span class="font-medium bg-slate-100 px-2 py-0.5 rounded">ğŸ“ Proyek:</span><span>${task.project}</span></div><div class="flex items-center gap-2"><span class="font-medium bg-slate-100 px-2 py-0.5 rounded">ğŸ§‘â€ğŸ’» PIC:</span><span>${task.pic}</span></div><div class="flex items-center gap-2"><span class="font-medium bg-slate-100 px-2 py-0.5 rounded">ğŸ—“ï¸ Deadline:</span><span>${formattedDate}</span></div></div><div class="flex items-center justify-between border-t border-slate-200 pt-3"><select class="status-changer text-xs w-full bg-slate-50 border-slate-200 rounded-md p-1 focus:ring-1 focus:ring-teal-500 focus:border-teal-500"><option value="todo" ${task.status === "todo" ? "selected" : ""}>Belum Dikerjakan</option><option value="inprogress" ${task.status === "inprogress" ? "selected" : ""}>Dikerjakan</option><option value="done" ${task.status === "done" ? "selected" : ""}>Selesai</option></select><button class="delete-task-btn text-slate-400 hover:text-red-500 transition ml-2 p-1 rounded-full hover:bg-red-100" title="Hapus Tugas"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
    
    card.querySelector(".delete-task-btn").addEventListener("click", (e) => { e.stopPropagation(); deleteTask(task._id); });
    card.querySelector(".status-changer").addEventListener("change", e => updateTaskStatus(task._id, e.target.value));
    
    return card;
};

    const renderProjectList = () => {
        projectList.innerHTML = "";
        const projects = appData.projects;
        if (projects.length === 0) {
            projectList.innerHTML = `<li class="text-sm text-slate-500 text-center p-4">Belum ada proyek.</li>`;
            return;
        }
        projects.forEach(p => {
            const li = document.createElement("li");
            li.className = "flex items-center justify-between text-sm p-2 rounded-md hover:bg-slate-100";
            li.innerHTML = `<span class="font-medium">${p.name}</span><button class="delete-project-btn text-slate-400 hover:text-red-500 transition p-1 rounded-full hover:bg-red-100" title="Hapus proyek ${p.name}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
            li.querySelector(".delete-project-btn").onclick = () => deleteProject(p._id);
            projectList.appendChild(li);
        });
    };

    const populateDropdowns = (isInitial = false) => {
        const projects = appData.projects;
        [taskProjectSelect, projectFilter].forEach(s => {
            const currentVal = s.value;
            s.innerHTML = `<option value="">Pilih Proyek</option>`;
            if (s.id.includes('filter')) s.innerHTML += `<option value="all">Semua Proyek</option>`;
            projects.forEach(p => s.innerHTML += `<option value="${p.name}">${p.name}</option>`);
            // PERBAIKAN: Set ke 'all' saat pertama kali dimuat
            if (isInitial && s.id.includes('filter')) {
                s.value = 'all';
            } else {
                s.value = currentVal;
            }
        });
        [taskPicSelect, memberFilter].forEach(s => {
            const currentVal = s.value;
            s.innerHTML = `<option value="">Pilih Anggota Tim</option>`;
            if (s.id.includes('filter')) s.innerHTML += `<option value="all">Semua Anggota</option>`;
            teamMembers.forEach(m => s.innerHTML += `<option value="${m}">${m}</option>`);
            // PERBAIKAN: Set ke 'all' saat pertama kali dimuat
            if (isInitial && s.id.includes('filter')) {
                s.value = 'all';
            } else {
                s.value = currentVal;
            }
        });
    };

    const renderAll = (isInitial = false) => {
        // PERBAIKAN: Kirim status 'isInitial' ke populateDropdowns
        populateDropdowns(isInitial);
        renderProjectList();
        applyFilters();
    };
    
    // --- INITIALIZATION FUNCTION ---
    const initializeApp = async () => {
        navButtons.forEach(button => button.addEventListener('click', () => switchView(button.id.replace('nav-', ''))));
        mobileNav.addEventListener('change', (e) => switchView(e.target.value));
        projectForm.addEventListener('submit', addProject);
        taskForm.addEventListener('submit', addTask);
        projectFilter.addEventListener('change', applyFilters);
        memberFilter.addEventListener('change', applyFilters);
        
        await fetchData();
        // PERBAIKAN: Panggil renderAll dengan penanda 'initial'
        renderAll(true);
        switchView('dashboard');
    };

    // Jalankan aplikasi
    initializeApp();
});
</script>

</body>
</html>